<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XR-9000構成アプリケーション Osaka Branch ver2</title>
    <!-- Icon library (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/lu.min.js"></script>
    <style>
        /* 基本デザインをスタイリッシュに */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            background-color: #f9fafb;
            color: #1f2937;
            display: flex;
        }
        /* コンテナとスプラッシュ */
        .container {
            display: none;
            width: 100%;
            min-height: 100vh;
        }
        .splash-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #fff;
            z-index: 1000;
            transition: opacity 1s ease-out;
        }
        .splash-screen img {
            max-width: 100%;
            max-height: 100%;
        }
        /* 左パネル(質問) */
        .questions {
            width: 35%;
            padding: 20px;
            background-color: #fff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            position: relative;
        }
        .logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 80px;
            height: auto;
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .app-title {
            text-align: center;
            margin: 0;
            margin-bottom: 16px;
            font-size: 1.4rem;
            font-weight: 700;
            color: #1f2937;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #1f2937;
        }
        .question {
            margin-bottom: 20px;
        }
        .question label {
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
        }
        .question input[type="number"],
        .question select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #fff;
            color: #1f2937;
        }
        .question input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        /* 右パネル(結果) */
        .results {
            width: 65%;
            padding: 20px;
            background-color: #fff;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            overflow-y: auto;
        }
        .result-section {
            width: 100%;
            margin-bottom: 20px;
        }
        .result {
            margin-top: 12px;
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .image-section {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
        }
        .image-section img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }
        /* ボタン類 */
        .button-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px 16px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .icon-button:hover {
            background-color: #2563eb;
        }
        /* 動画エリア */
        .video-section {
            width: 100%;
            margin-top: 20px;
        }
        .video-section iframe {
            width: 100%;
            height: 360px;
            border: none;
            border-radius: 6px;
        }
        /* エクスポート */
        .export-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }
        .export-select {
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #1f2937;
        }
        /* モーダル関連 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 1200px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        .close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 24px;
            font-weight: bold;
            color: #4b5563;
            cursor: pointer;
        }
        .close:hover {
            color: #1f2937;
        }
        /* YouTubeセクション：XR-9000紹介 */
        .youtube-section {
            width: 100%;
            margin-top: 30px;
        }
        .youtube-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1f2937;
        }
        .youtube-section iframe {
            width: 100%;
            height: 360px;
            border: none;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- スプラッシュスクリーン -->
    <div class="splash-screen" id="splashScreen">
        <img id="splashImage" src="images/background.png" alt="Background Image">
    </div>

    <!-- メインコンテナ -->
    <div class="container" id="mainContent">
        <!-- 左パネル：質問 -->
        <div class="questions">
            <img src="images/logo.png" alt="Logo" class="logo">
            <h1 class="app-title gradient-text">XR-9000構成アプリケーション<br>Osaka Branch ver2</h1>

            <div class="section-title">1-1 XRモジュール台数</div>
            <div class="question">
                <label for="q1">1. 1日の検体数は？</label>
                <input type="number" id="q1" min="0" placeholder="例: 800">
            </div>
            <div class="question">
                <label for="q2">2. 1時間当たりの最大検体数は？</label>
                <input type="number" id="q2" min="0" placeholder="例: 100">
            </div>

            <div class="section-title">1-2 ツイン/シングルモジュールの選択</div>
            <div class="question">
                <label for="q3">3. 別号機再検の希望は？</label>
                <select id="q3">
                    <option value="あり">あり</option>
                    <option value="なし">なし</option>
                </select>
            </div>

            <div class="section-title">1-3 濃縮試薬(RU)の選択</div>
            <div class="checkbox-container">
                <label for="q5-1">5. セルパックの交換頻度を減らしたい</label>
                <input type="checkbox" id="q5-1">
            </div>
            <div class="checkbox-container">
                <label for="q6-1">6. セルパックの在庫スペースを削減したい</label>
                <input type="checkbox" id="q6-1">
            </div>

            <div class="section-title">1-4 オプションチャンネルの有無</div>
            <div class="checkbox-container">
                <label for="q7-1">7. 造血幹細胞移植をしている</label>
                <input type="checkbox" id="q7-1">
            </div>
            <div class="checkbox-container">
                <label for="q8-1">8. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい</label>
                <input type="checkbox" id="q8-1">
            </div>
            <div class="checkbox-container">
                <label for="q9-1">9. IPFの臨床要望がある</label>
                <input type="checkbox" id="q9-1">
            </div>
            <div class="checkbox-container">
                <label for="q10-1">10. PLT 5万以下の検体数が多い</label>
                <input type="checkbox" id="q10-1">
            </div>
            <div class="checkbox-container">
                <label for="q11-1">11. 破砕赤血球の出現検体が時々ある</label>
                <input type="checkbox" id="q11-1">
            </div>

            <div class="section-title">1-5 体液の機械値報告をしたい</div>
            <div class="checkbox-container">
                <label for="q12-1">12. 体液の機械値報告をしたい</label>
                <input type="checkbox" id="q12-1">
            </div>
            <div class="checkbox-container">
                <label for="q13-1">13. 当直帯に体液検体の報告が必要</label>
                <input type="checkbox" id="q13-1">
            </div>
            <div class="checkbox-container">
                <label for="q14-1">14. 体液の鏡検者の不足またはスキル継続に課題がある</label>
                <input type="checkbox" id="q14-1">
            </div>

            <div class="section-title">2-1 SP-50の台数</div>
            <div class="question">
                <label for="q15">15. 標本枚数/日は？</label>
                <input type="number" id="q15" min="0" placeholder="例: 150">
            </div>

            <div class="section-title">3-1 DI-60の有無</div>
            <div class="question">
                <label for="q16">16. 現在、血液像自動分析装置の有無は？</label>
                <select id="q16">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="checkbox-container">
                <label for="q17-1">17. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい</label>
                <input type="checkbox" id="q17-1">
            </div>
            <div class="checkbox-container">
                <label for="q18-1">18. 検査室内での鏡検スキルの平準化を進めたい</label>
                <input type="checkbox" id="q18-1">
            </div>

            <div class="section-title">4-1 TS-10の位置(先頭, 真ん中, 最後尾)</div>
            <div class="question">
                <label for="q19">19. SPないしDIが複数台数あるか？</label>
                <select id="q19">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="question">
                <label for="q20">20. 設置面積をできる限り狭くしたいか？</label>
                <select id="q20">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="question">
                <label for="q21">21. TS-10の検体回収作業を端で行いたいか？</label>
                <select id="q21">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>

            <div class="section-title">5-1 血液・凝固検査の効率化</div>
            <div class="checkbox-container">
                <label for="q22-1">22. 血液・凝固検査を含めた自動化を進めたい</label>
                <input type="checkbox" id="q22-1">
            </div>
            <div class="checkbox-container">
                <label for="q23-1">23. 血液・凝固検査の担当人員を減らしたい</label>
                <input type="checkbox" id="q23-1">
            </div>
            <div class="checkbox-container">
                <label for="q24-1">24. 夜間当直帯の装置オペレーションを少なくしたい</label>
                <input type="checkbox" id="q24-1">
            </div>
        </div>

        <!-- 右パネル：結果 -->
        <div class="results">
            <!-- ボタンコンテナ -->
            <div class="button-container">
                <button class="icon-button" onclick="calculateResult()">
                    <i data-lucide="play-circle"></i>
                    結果を表示
                </button>
                <button class="icon-button" onclick="openModal()">
                    <i data-lucide="maximize"></i>
                    拡大表示
                </button>
            </div>

            <div class="result-section">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">ご提案構成イメージ</h3>
                <h4 style="margin-top: 4px; color: #6b7280; font-weight: 400;">※ST-40、ST-41の配置は参考です。</h4>
                <div class="result" id="result"></div>
            </div>
            <div class="image-section">
                <img id="patternImage" src="" alt="構成パターン図">
            </div>
            <!-- Vimeo動画 -->
            <div class="video-section" id="videoContainer"></div>

            <!-- XR-9000紹介：YouTube -->
            <div class="youtube-section">
                <iframe src="https://www.youtube.com/embed/_S8trQsU-J0" allowfullscreen></iframe>
            </div>

            <!-- エクスポート選択 -->
            <div class="export-container">
                <label for="exportSelect" style="font-weight: 500; color: #4b5563;">エクスポート形式:</label>
                <select class="export-select" id="exportSelect">
                    <option value="csv">CSV</option>
                    <option value="txt">Text</option>
                    <option value="xls">Excel</option>
                    <option value="json">JSON</option>
                </select>
                <button class="icon-button" onclick="exportResult()">
                    <i data-lucide="download"></i>
                    エクスポート
                </button>
            </div>
        </div>
    </div>

    <!-- モーダルウィンドウ -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="result-section" style="margin-top: 20px;">
                <h2 style="margin: 0; font-size: 1rem; font-weight: 600;">ご提案構成イメージ</h2>
                <h4 style="margin-top: 4px; color: #6b7280; font-weight: 400;">※ST-40、ST-41の配置は参考です。</h4>
                <div class="result" id="modalResult"></div>
            </div>
            <div class="image-section">
                <img id="modalPatternImage" src="" alt="構成パターン図">
            </div>
            <div class="button-container" id="pdfButtonContainer" style="margin-top: 20px;">
                <!-- PDFボタンは削除済み -->
            </div>
        </div>
    </div>

    <script>
        /*
          lucideアイコンの描画初期化
        */
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        function calculateResult() {
            const q1 = parseInt(document.getElementById('q1').value) || 0;
            const q2 = parseInt(document.getElementById('q2').value) || 0;
            const q3 = document.getElementById('q3').value;
            //const q4 = document.getElementById('q4').value;
            const q5 = document.getElementById('q5-1').checked;
            const q6 = document.getElementById('q6-1').checked;
            const q7 = document.getElementById('q7-1').checked;
            const q8 = document.getElementById('q8-1').checked;
            const q9 = document.getElementById('q9-1').checked;
            const q10 = document.getElementById('q10-1').checked;
            const q11 = document.getElementById('q11-1').checked;
            const q12 = document.getElementById('q12-1').checked;
            const q13 = document.getElementById('q13-1').checked;
            const q14 = document.getElementById('q14-1').checked;
            const q15 = parseInt(document.getElementById('q15').value) || 0;
            const q16 = document.getElementById('q16').value;
            const q17 = document.getElementById('q17-1').checked;
            const q18 = document.getElementById('q18-1').checked;
            const q19 = document.getElementById('q19').value;
            const q20 = document.getElementById('q20').value;
            const q21 = document.getElementById('q21').value;
            const q22 = document.getElementById('q22-1').checked;
            const q23 = document.getElementById('q23-1').checked;
            const q24 = document.getElementById('q24-1').checked;

            let xrCount1;
            if (q1 >= 1200) {
                xrCount1 = 6;
            } else if (q1 >= 1000) {
                xrCount1 = 5;
            } else if (q1 >= 800) {
                xrCount1 = 4;
            } else if (q1 >= 600) {
                xrCount1 = 3;
            } else {
                xrCount1 = 2;
            }

            let xrCount2;
            if (q2 >= 400) {
                xrCount2 = 5;
            } else if (q2 >= 300) {
                xrCount2 = 4;
            } else if (q2 >= 200) {
                xrCount2 = 3;
            } else if (q2 >= 100) {
                xrCount2 = 2;
            } else {
                xrCount2 = 1;
            }

            const xrCount = Math.max(xrCount1, xrCount2);

let moduleType;
if (q3 === 'あり' && xrCount % 2 === 0) {
    moduleType = 'ツインモジュール';
} else {
    moduleType = 'シングルモジュール';
}

let ru = (q5 || q6) ? 'RUあり' : 'RUなし';
let wpc = (q7 || q8) ? 'WPCチャンネルあり(XR-20)' : 'WPCチャンネルなし(XR-10)';
let pltF = (q9 || q10 || q11) ? 'PLT-Fチャンネルあり' : 'PLT-Fチャンネルなし';
let bf = (q12 || q13 || q14) ? 'BFモードあり' : 'BFモードなし';

let sp50 = (q15 < 150) ? 'SP-50 1台' : 'SP-50 2台';
let di60 = (q16 === 'あり' || q17 || q18) ? 'DI-60あり' : 'DI-60なし';

let ts10;
if (q21 === 'あり') {
    ts10 = 'TS-10最後尾配置';
} else {
    ts10 = 'TS-10中央配置';
}

let bloodScience = (q22 || q23 || q24) ? 'BloodScience Workcellの提案' : 'BloodScience Workcellなし';

// 最終構成パターン図番号の計算
let patternNumber = 0;
if (xrCount === 2) {
    if (moduleType === 'ツインモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 1 : 2;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 3 : 4;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 5 : 6;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 7 : 8;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 9 : 10;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 11 : 12;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 13 : 14;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 15 : 16;
                }
            }
        }
    } else {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 17 : 18;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 19 : 20;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 21 : 22;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 23 : 24;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 25 : 26;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 27 : 28;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 29 : 30;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 31 : 32;
                }
            }
        }
    }
} else if (xrCount === 4) {
    if (moduleType === 'ツインモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 33 : 34;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 35 : 36;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 37 : 38;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 39 : 40;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 41 : 42;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 43 : 44;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 45 : 46;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 47 : 48;
                }
            }
        }
    } else {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 49 : 50;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 51 : 52;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 53 : 54;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 55 : 56;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 57 : 58;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 59 : 60;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 61 : 62;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 63 : 64;
                }
            }
        }
    }
} else if (xrCount === 6) {
    if (moduleType === 'ツインモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 65 : 66;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 67 : 68;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 69 : 70;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 71 : 72;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 73 : 74;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 75 : 76;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 77 : 78;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 79 : 80;
                }
            }
        }
    } else {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 81 : 82;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 83 : 84;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 85 : 86;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 87 : 88;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 89 : 90;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 91 : 92;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 93 : 94;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 95 : 96;
                }
            }
        }
    }
} else if (xrCount === 3) {
    if (moduleType === 'シングルモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 97 : 98;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 99 : 100;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 101 : 102;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 103 : 104;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 105 : 106;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 107 : 108;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 109 : 110;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 111 : 112;
                }
            }
        }
    }
} else if (xrCount === 5) {
    if (moduleType === 'シングルモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 113 : 114;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 115 : 116;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 117 : 118;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 119 : 120;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 121 : 122;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 123 : 124;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 125 : 126;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 127 : 128;
                }
            }
        }
    }
}


            // 出力
            document.getElementById('result').innerText = `\n    XRモジュール台数: ${xrCount}台\n    モジュールタイプ: ${moduleType}\n    濃縮試薬(RU): ${ru}\n    WPCチャンネル: ${wpc}\n    PLT-Fチャンネル: ${pltF}\n    BFモード: ${bf}\n    SP-50数: ${sp50}\n    DI-60: ${di60}\n    TS-10の位置: ${ts10}\n    BloodScience Workcell: ${bloodScience}\n    最終構成パターン図番号: ${patternNumber}\n`;

            // パターン番号に応じた画像
            const patternImage = document.getElementById('patternImage');
            patternImage.src = `images/pattern${patternNumber}.png`;
            patternImage.alt = `構成パターン図 ${patternNumber}`;

            // 動画の埋め込み
            const videoContainer = document.getElementById('videoContainer');
            if (q22 || q23 || q24) {
                // BloodScience Workcellに関する動画
                videoContainer.innerHTML = `\n<iframe src="https://player.vimeo.com/video/843146377" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = "";
            }

            // モーダルにも反映
            document.getElementById('modalResult').innerText = document.getElementById('result').innerText;
            const modalPatternImage = document.getElementById('modalPatternImage');
            modalPatternImage.src = patternImage.src;
            modalPatternImage.alt = patternImage.alt;
        }

        function openModal() {
            calculateResult();
            document.getElementById('resultModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('resultModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // エクスポート
        function exportResult() {
            calculateResult();
            const exportFormat = document.getElementById('exportSelect').value;
            const resultText = document.getElementById('result').innerText.trim();

            if (exportFormat === 'csv') {
                exportAsCSV(resultText);
            } else if (exportFormat === 'txt') {
                exportAsText(resultText);
            } else if (exportFormat === 'xls') {
                exportAsExcel(resultText);
            } else if (exportFormat === 'json') {
                exportAsJSON(resultText);
            } else {
                alert('エクスポート形式を選択してください');
            }
        }

        function exportAsCSV(text) {
            const lines = text.split('\n');
            let csvLines = [];
            for (let line of lines) {
                let trimmed = line.trim();
                if (trimmed) {
                    const parts = trimmed.split(':');
                    if (parts.length === 2) {
                        const key = parts[0].trim().replace(/\s/g, ' ');
                        const val = parts[1].trim().replace(/\s/g, ' ');
                        csvLines.push(`"${key}","${val}"`);
                    } else {
                        csvLines.push(`"${trimmed}"`);
                    }
                }
            }
            const csvContent = csvLines.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsText(text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsExcel(text) {
            const lines = text.split('\n');
            let tableHTML = '<table border="1" style="border-collapse:collapse;">';
            tableHTML += '<tbody>';
            for (let line of lines) {
                let trimmed = line.trim();
                if (trimmed) {
                    const parts = trimmed.split(':');
                    if (parts.length === 2) {
                        const key = parts[0].trim();
                        const val = parts[1].trim();
                        tableHTML += `<tr><td>${key}</td><td>${val}</td></tr>`;
                    } else {
                        tableHTML += `<tr><td colspan="2">${trimmed}</td></tr>`;
                    }
                }
            }
            tableHTML += '</tbody></table>';

            const blob = new Blob(["\ufeff" + tableHTML], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.xls';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsJSON(text) {
            const lines = text.split('\n');
            let jsonObject = {};
            for (let line of lines) {
                let trimmed = line.trim();
                if (!trimmed) continue;
                const parts = trimmed.split(':');
                if (parts.length === 2) {
                    let key = parts[0].trim();
                    let val = parts[1].trim();
                    jsonObject[key] = val;
                } else {
                    jsonObject['その他'] = trimmed;
                }
            }
            const jsonString = JSON.stringify(jsonObject, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // スプラッシュスクリーン
        window.onload = function() {
            const splashScreen = document.getElementById('splashScreen');
            const mainContent = document.getElementById('mainContent');
            // 2秒後にフェードアウト
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    // アイコン描画
                    lucide.createIcons();
                }, 500);
            }, 2000);
        };
    </script>
</body>
</html>
