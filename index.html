<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XR-9000構成アプリケーション Osaka Branch ver2</title>
    <!-- Icon library (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/lu.min.js"></script>
    <style>
        /* 基本デザインをスタイリッシュに */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            background-color: #f9fafb;
            color: #1f2937;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        /* コンテナとスプラッシュ */
        .container {
            display: none;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        .splash-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #fff;
            z-index: 1000;
            transition: opacity 1s ease-out;
        }
        .splash-screen img {
            max-width: 100%;
            max-height: 100%;
        }
        /* 左パネル(質問) */
        .questions {
            width: 35%;
            padding: 20px;
            background-color: #fff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            position: relative;
            height: calc(100vh - 40px); /* 上下のパディングを考慮 */
        }
        .logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 80px;
            height: auto;
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .app-title {
            text-align: center;
            margin: 0;
            margin-bottom: 16px;
            font-size: 1.4rem;
            font-weight: 700;
            color: #1f2937;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 28px;
            margin-bottom: 16px;
            color: var(--gray-800);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        .question {
            background-color: var(--gray-50);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            transform: translateX(-20px);
            opacity: 0;
            animation: slideIn 0.5s forwards;
        }
        .question:hover {
            background-color: var(--gray-100);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .question label {
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
        }
        .question input[type="number"],
        .question select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #fff;
            color: #1f2937;
        }
        .question input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            transition: transform 0.2s ease;
        }
        .checkbox-container:hover {
            transform: translateX(4px);
        }
        /* 右パネル(結果) */
        .results {
            width: 65%;
            padding: 20px;
            background-color: #fff;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            overflow-y: auto;
            height: 100vh;
        }
        .result-section {
            width: 100%;
            margin-bottom: 20px;
        }
        .result {
            margin-top: 16px;
            background-color: var(--gray-50);
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8;
            white-space: pre-wrap;
            border: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out;
        }
        /* 結果テキストの余白調整 */
        #result, #modalResult {
            white-space: pre-wrap;
            margin: 0;
            padding: 0;
        }
        .image-section {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
        }
        .image-section img {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .image-section img:hover {
            transform: scale(1.02);
        }
        /* ボタン類 */
        .button-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px 16px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .icon-button:hover {
            background-color: #2563eb;
        }
        .icon-button:active {
            transform: scale(0.98);
        }
        /* 動画エリア */
        .video-section {
            width: 100%;
            margin-top: 20px;
            position: relative;
            padding-top: 56.25%; /* 16:9のアスペクト比を維持 */
        }
        .video-section iframe {
            width: 100%;
            border: none;
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }
        /* エクスポート */
        .export-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .export-select {
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #1f2937;
            min-width: 100px;
        }
        /* モーダル関連 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 1200px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        .close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 24px;
            font-weight: bold;
            color: #4b5563;
            cursor: pointer;
        }
        .close:hover {
            color: #1f2937;
        }
        /* YouTubeセクション：XR-9000紹介 */
        .youtube-section {
            width: 100%;
            margin-top: 30px;
            position: relative;
            padding-top: 56.25%; /* 16:9のアスペクト比を維持 */
        }
        .youtube-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1f2937;
        }
        .youtube-section iframe {
            width: 100%;
            border: none;
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --dark-bg: #1a1a1a;
            --dark-text: #e5e7eb;
            --dark-surface: #2d2d2d;
        }

        .icon-button {
            background-color: var(--primary);
        }
        .icon-button:hover {
            background-color: var(--primary-hover);
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
            }
            .questions, .results {
                width: 100%;
                height: auto;
                padding: 16px;
            }
            .app-title {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }
            .logo {
                width: 60px;
            }
        }

        @media (max-width: 640px) {
            .button-container {
                flex-direction: column;
                gap: 8px;
            }
            .icon-button {
                width: 100%;
                justify-content: center;
                padding: 12px;
            }
            .question {
                padding: 12px;
            }
            .section-title {
                font-size: 1rem;
                margin-top: 20px;
                margin-bottom: 12px;
            }
            .result {
                padding: 16px;
                font-size: 0.9rem;
            }
            .image-section img {
                max-height: 300px;
            }
            .video-section iframe,
            .youtube-section iframe {
                height: 240px;
            }
            .export-container {
                flex-direction: column;
                gap: 8px;
            }
            .export-select {
                width: 100%;
            }
            /* モーダルの調整 */
            .modal-content {
                margin: 10px;
                padding: 16px;
            }
        }

        @media print {
            .questions {
                width: 100%;
                height: auto;
            }
            .results {
                width: 100%;
                height: auto;
                page-break-before: always;
            }
            .button-container,
            .video-section,
            .youtube-section {
                display: none;
            }
            .result {
                border: 1px solid #000;
            }
            .image-section img {
                max-height: 500px;
            }
        }

        /* エラーメッセージのスタイル */
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 4px;
        }

        /* 入力フィールドのバリデーション表示 */
        .question input:invalid {
            border-color: #dc2626;
            background-color: #fef2f2;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--dark-bg);
                color: var(--dark-text);
            }
            .questions, .results {
                background-color: var(--dark-surface);
            }
            .question {
                background-color: rgba(255, 255, 255, 0.05);
            }
            .result {
                background-color: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }
        }

        /* 質問セクションのアニメーション */
        @keyframes slideIn {
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 結果表示のアニメーション */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            padding: 5px 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 1.2rem;
            }
            .section-title {
                font-size: 1rem;
            }
            .export-container {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 60px;
            }
            .export-select {
                margin-bottom: 8px;
                width: 100%;
            }
            .result-card {
                margin: 10px;
            }
            
            .result-item {
                flex-direction: column;
                gap: 4px;
            }
            
            .image-section img {
                max-height: 300px;
            }
            
            .quick-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: white;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.1)
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            to {
                background-position: -200% 0;
            }
        }

        .quick-nav {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-200);
        }
        .nav-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--gray-200);
        }
        /* 入力フィールドのフォーカス効果を改善 */
        .question input:focus,
        .question select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* チェックボックスをカスタマイズ */
        .custom-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray-300);
            border-radius: 4px;
            margin-right: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 結果セクションのカード化 */
        .result-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .result-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .result-value {
            color: var(--primary);
            font-weight: 600;
        }

        .help-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }

        .help-icon {
            width: 16px;
            height: 16px;
            color: var(--gray-400);
            cursor: pointer;
        }

        .help-content {
            display: none;
            position: absolute;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 200px;
            z-index: 100;
        }

        .help-tooltip:hover .help-content {
            display: block;
        }
    </style>
</head>
<body>
    <!-- スプラッシュスクリーン -->
    <div class="splash-screen" id="splashScreen">
        <img id="splashImage" src="images/background.png" alt="Background Image">
    </div>

    <!-- メインコンテナ -->
    <div class="container" id="mainContent">
        <!-- 左パネル：質問 -->
        <div class="questions">
            <img src="images/logo.png" alt="Logo" class="logo">
            <h1 class="app-title gradient-text">XR-9000構成アプリケーション<br>Osaka Branch ver2</h1>

            <div class="section-title">1-1 XRモジュール台数</div>
            <div class="question">
                <label for="q1">1. 1日の検体数は？</label>
                <input type="number" id="q1" min="0" placeholder="例: 800">
            </div>
            <div class="question">
                <label for="q2">2. 1時間当たりの最大検体数は？</label>
                <input type="number" id="q2" min="0" placeholder="例: 100">
            </div>

            <div class="section-title">1-2 ツイン/シングルモジュールの選択</div>
            <div class="question">
                <label for="q3">3. 別号機再検の希望は？</label>
                <select id="q3">
                    <option value="あり">あり</option>
                    <option value="なし">なし</option>
                </select>
            </div>

            <div class="section-title">1-3 濃縮試薬(RU)の選択</div>
            <div class="checkbox-container">
                <label for="q4-1">4. セルパックの交換頻度を減らしたい</label>
                <input type="checkbox" id="q4-1">
            </div>
            <div class="checkbox-container">
                <label for="q5-1">5. セルパックの在庫スペースを削減したい</label>
                <input type="checkbox" id="q5-1">
            </div>

            <div class="section-title">1-4 オプションチャンネルの有無</div>
            <div class="checkbox-container">
                <label for="q6-1">6. 造血幹細胞移植をしている</label>
                <input type="checkbox" id="q6-1">
            </div>
            <div class="checkbox-container">
                <label for="q7-1">7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい</label>
                <input type="checkbox" id="q7-1">
            </div>
            <div class="checkbox-container">
                <label for="q8-1">8. IPFの臨床要望がある</label>
                <input type="checkbox" id="q8-1">
            </div>
            <div class="checkbox-container">
                <label for="q9-1">9. PLT 5万以下の検体数が多い</label>
                <input type="checkbox" id="q9-1">
            </div>
            <div class="checkbox-container">
                <label for="q10-1">10. 破砕赤血球の出現検体が時々ある</label>
                <input type="checkbox" id="q10-1">
            </div>

            <div class="section-title">1-5 体液の機械値報告をしたい</div>
            <div class="checkbox-container">
                <label for="q11-1">11. 体液の機械値報告をしたい</label>
                <input type="checkbox" id="q11-1">
            </div>
            <div class="checkbox-container">
                <label for="q12-1">12. 当直帯に体液検体の報告が必要</label>
                <input type="checkbox" id="q12-1">
            </div>
            <div class="checkbox-container">
                <label for="q13-1">13. 体液の鏡検者の不足またはスキル継続に課題がある</label>
                <input type="checkbox" id="q13-1">
            </div>

            <div class="section-title">2-1 SP-50の台数</div>
            <div class="question">
                <label for="q14">14. 標本枚数/日は？</label>
                <input type="number" id="q14" min="0" placeholder="例: 150">
            </div>

            <div class="section-title">3-1 DI-60の有無</div>
            <div class="question">
                <label for="q15">15. 現在、血液像自動分析装置の有無は？</label>
                <select id="q15">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="checkbox-container">
                <label for="q16-1">16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい</label>
                <input type="checkbox" id="q16-1">
            </div>
            <div class="checkbox-container">
                <label for="q17-1">17. 検査室内での鏡検スキルの平準化を進めたい</label>
                <input type="checkbox" id="q17-1">
            </div>

            <div class="section-title">4-1 TS-10の位置(先頭, 真ん中, 最後尾)</div>
            <div class="question">
                <label for="q18">18. SPないしDIが複数台数あるか？</label>
                <select id="q18">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="question">
                <label for="q19">19. 設置面積をできる限り狭くしたいか？</label>
                <select id="q19">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="question">
                <label for="q20">20. TS-10の検体回収作業を端で行いたいか？</label>
                <select id="q20">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>

            <div class="section-title">5-1 血液・凝固検査の効率化</div>
            <div class="checkbox-container">
                <label for="q21-1">21. 血液・凝固検査を含めた自動化を進めたい</label>
                <input type="checkbox" id="q21-1">
            </div>
            <div class="checkbox-container">
                <label for="q22-1">22. 血液・凝固検査の担当人員を減らしたい</label>
                <input type="checkbox" id="q22-1">
            </div>
            <div class="checkbox-container">
                <label for="q23-1">23. 夜間当直帯の装置オペレーションを少なくしたい</label>
                <input type="checkbox" id="q23-1">
            </div>
        </div>

        <!-- 右パネル：結果 -->
        <div class="results">
            <!-- ボタンコンテナ -->
            <div class="button-container">
                <button class="icon-button" onclick="calculateResult()">
                    <i data-lucide="play-circle"></i>
                    結果表示
                </button>
                <button class="icon-button" onclick="openModal()">
                    <i data-lucide="maximize"></i>
                    拡大表示
                </button>
            </div>

            <div class="result-section">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">ご提案構成イメージ</h3>
                <h4 style="margin-top: 4px; color: #6b7280; font-weight: 400;">※ST-40、ST-41の配置は参考です。</h4>
                <div class="result" id="result"></div>
            </div>
            <div class="image-section">
                <img id="patternImage" src="" alt="">
            </div>
            <!-- Vimeo動画 -->
            <div class="video-section" id="videoContainer"></div>

            <!-- XR-9000紹介：YouTube -->
            <div class="youtube-section">
                <iframe src="https://www.youtube.com/embed/_S8trQsU-J0" allowfullscreen></iframe>
            </div>

            <!-- エクスポート選択 -->
            <div class="export-container">
                <label for="exportSelect" style="font-weight: 500; color: #4b5563;">エクスポート形式:</label>
                <select class="export-select" id="exportSelect">
                    <option value="csv">CSV</option>
                    <option value="txt">Text</option>
                    <option value="xls">Excel</option>
                    <option value="json">JSON</option>
                </select>
                <button class="icon-button" onclick="exportResult()">
                    <i data-lucide="download"></i>
                    エクスポート
                </button>
            </div>
        </div>
    </div>

    <!-- モーダルウィンドウ -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="result-section" style="margin-top: 20px;">
                <h2 style="margin: 0; font-size: 1rem; font-weight: 600;">ご提案構成イメージ</h2>
                <h4 style="margin-top: 4px; color: #6b7280; font-weight: 400;">※ST-40、ST-41の配置は参考です。</h4>
                <div class="result" id="modalResult"></div>
            </div>
            <div class="image-section">
                <img id="modalPatternImage" src="" alt="">
            </div>
            <div class="button-container" id="pdfButtonContainer" style="margin-top: 20px;">
                <!-- PDFボタンは削除済み -->
            </div>
        </div>
    </div>

    <div class="help-tooltip" data-title="ヘルプ">
        <i data-lucide="help-circle" class="help-icon"></i>
        <div class="help-content">
            <h4>入力のヒント</h4>
            <p>このセクションでは...</p>
        </div>
    </div>

    <script>
        /*
          lucideアイコンの描画初期化
        */
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        function calculateResult() {
            const q1 = parseInt(document.getElementById('q1').value) || 0;
            const q2 = parseInt(document.getElementById('q2').value) || 0;
            const q3 = document.getElementById('q3').value;
            const q4 = document.getElementById('q4-1').checked;
            const q5 = document.getElementById('q5-1').checked;
            const q6 = document.getElementById('q6-1').checked;
            const q7 = document.getElementById('q7-1').checked;
            const q8 = document.getElementById('q8-1').checked;
            const q9 = document.getElementById('q9-1').checked;
            const q10 = document.getElementById('q10-1').checked;
            const q11 = document.getElementById('q11-1').checked;
            const q12 = document.getElementById('q12-1').checked;
            const q13 = document.getElementById('q13-1').checked;
            const q14 = parseInt(document.getElementById('q14').value) || 0;
            const q15 = document.getElementById('q15').value;
            const q16 = document.getElementById('q16-1').checked;
            const q17 = document.getElementById('q17-1').checked;
            const q18 = document.getElementById('q18').value;
            const q19 = document.getElementById('q19').value;
            const q20 = document.getElementById('q20').value;
            const q21 = document.getElementById('q21-1').checked;
            const q22 = document.getElementById('q22-1').checked;
            const q23 = document.getElementById('q23-1').checked;

            let xrCount1;
            if (q1 >= 1200) {
                xrCount1 = 6;
            } else if (q1 >= 1000) {
                xrCount1 = 5;
            } else if (q1 >= 800) {
                xrCount1 = 4;
            } else if (q1 >= 600) {
                xrCount1 = 3;
            } else {
                xrCount1 = 2;
            }

            let xrCount2;
            if (q2 >= 400) {
                xrCount2 = 5;
            } else if (q2 >= 300) {
                xrCount2 = 4;
            } else if (q2 >= 200) {
                xrCount2 = 3;
            } else if (q2 >= 100) {
                xrCount2 = 2;
            } else {
                xrCount2 = 1;
            }

            const xrCount = Math.max(xrCount1, xrCount2);

            let moduleType;
            if (q3 === 'あり' && xrCount % 2 === 0) {
                moduleType = 'ツインモジュール';
            } else {
                moduleType = 'シングルモジュール';
            }

            let ru = (q4 || q5) ? 'RUあり' : 'RUなし';
            let wpc = (q6 || q7) ? 'WPCチャンネルあり(XR-20)' : 'WPCチャンネルなし(XR-10)';
            let pltF = (q8 || q9 || q10) ? 'PLT-Fチャンネルあり' : 'PLT-Fチャンネルなし';
            let bf = (q11 || q12 || q13) ? 'BFモードあり' : 'BFモードなし';

            let sp50 = (q14 < 150) ? 'SP-50 1台' : 'SP-50 2台';
            let di60 = (q15 === 'あり' || q16 || q17) ? 'DI-60あり' : 'DI-60なし';

            let ts10;
            if (q20 === 'あり') {
                ts10 = 'TS-10最後尾配置';
            } else {
                ts10 = 'TS-10中央配置';
            }

            let bloodScience = (q21 || q22 || q23) ? 'BloodScience Workcellの提案' : 'BloodScience Workcellなし';

            // 最終構成パターン図番号の計算
            let patternNumber = 0;
            if (xrCount === 2) {
                if (moduleType === 'ツインモジュール') {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 1 : 2;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 3 : 4;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 5 : 6;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 7 : 8;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 9 : 10;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 11 : 12;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 13 : 14;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 15 : 16;
                            }
                        }
                    }
                } else {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 17 : 18;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 19 : 20;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 21 : 22;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 23 : 24;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 25 : 26;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 27 : 28;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 29 : 30;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 31 : 32;
                            }
                        }
                    }
                }
            } else if (xrCount === 4) {
                if (moduleType === 'ツインモジュール') {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 33 : 34;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 35 : 36;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 37 : 38;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 39 : 40;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 41 : 42;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 43 : 44;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 45 : 46;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 47 : 48;
                            }
                        }
                    }
                }
            } else if (xrCount === 6) {
                if (moduleType === 'ツインモジュール') {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 65 : 66;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 67 : 68;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 69 : 70;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 71 : 72;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 73 : 74;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 75 : 76;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 77 : 78;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 79 : 80;
                            }
                        }
                    }
                } else {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 81 : 82;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 83 : 84;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 85 : 86;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 87 : 88;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 89 : 90;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 91 : 92;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 93 : 94;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 95 : 96;
                            }
                        }
                    }
                }
            } else if (xrCount === 3) {
                if (moduleType === 'シングルモジュール') {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 97 : 98;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 99 : 100;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 101 : 102;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 103 : 104;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 105 : 106;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 107 : 108;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 109 : 110;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 111 : 112;
                            }
                        }
                    }
                }
            } else if (xrCount === 5) {
                if (moduleType === 'シングルモジュール') {
                    if (ru === 'RUあり') {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 113 : 114;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 115 : 116;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 117 : 118;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 119 : 120;
                            }
                        }
                    } else {
                        if (sp50 === 'SP-50 1台') {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 121 : 122;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 123 : 124;
                            }
                        } else {
                            if (di60 === 'DI-60なし') {
                                patternNumber = ts10 === 'TS-10中央配置' ? 125 : 126;
                            } else {
                                patternNumber = ts10 === 'TS-10中央配置' ? 127 : 128;
                            }
                        }
                    }
                }
            }

            // 出力
            document.getElementById('result').innerText = `XRモジュール台数: ${xrCount}台\nモジュールタイプ: ${moduleType}\n濃縮試薬(RU): ${ru}\nWPCチャンネル: ${wpc}\nPLT-Fチャンネル: ${pltF}\nBFモード: ${bf}\nSP-50数: ${sp50}\nDI-60: ${di60}\nTS-10の位置: ${ts10}\nBloodScience Workcell: ${bloodScience}\n最終構成パターン図番号: ${patternNumber}`;

            // パターン番号に応じた画像
            const patternImage = document.getElementById('patternImage');
            patternImage.src = `images/pattern${patternNumber}.png`;
            patternImage.alt = `構成パターン図 ${patternNumber}`;

            // 動画の埋め込み
            const videoContainer = document.getElementById('videoContainer');
            if (q21 || q22 || q23) {
                // BloodScience Workcellに関する動画
                videoContainer.innerHTML = `\n<iframe src="https://player.vimeo.com/video/843146377" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = "";
            }

            // モーダルにも反映
            document.getElementById('modalResult').innerText = document.getElementById('result').innerText;
            const modalPatternImage = document.getElementById('modalPatternImage');
            modalPatternImage.src = patternImage.src;
            modalPatternImage.alt = patternImage.alt;
        }

        function openModal() {
            calculateResult();
            document.getElementById('resultModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('resultModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // エクスポート
        function exportResult() {
            calculateResult();
            const exportFormat = document.getElementById('exportSelect').value;
            
            // 質問と回答を収集
            const qa = {
                "Q1. 1日の検体数": document.getElementById('q1').value || "未回答",
                "Q2. 1時間当たりの最大検体数": document.getElementById('q2').value || "未回答",
                "Q3. 別号機再検の希望": document.getElementById('q3').value || "未回答",
                "Q4. セルパックの交換頻度を減らしたい": document.getElementById('q4-1').checked ? "はい" : "いいえ",
                "Q5. セルパックの在庫スペースを削減したい": document.getElementById('q5-1').checked ? "はい" : "いいえ",
                "Q6. 造血幹細胞移植をしている": document.getElementById('q6-1').checked ? "はい" : "いいえ",
                "Q7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい": document.getElementById('q7-1').checked ? "はい" : "いいえ",
                "Q8. IPFの臨床要望がある": document.getElementById('q8-1').checked ? "はい" : "いいえ",
                "Q9. PLT 5万以下の検体数が多い": document.getElementById('q9-1').checked ? "はい" : "いいえ",
                "Q10. 破砕赤血球の出現検体が時々ある": document.getElementById('q10-1').checked ? "はい" : "いいえ",
                "Q11. 体液の機械値報告をしたい": document.getElementById('q11-1').checked ? "はい" : "いいえ",
                "Q12. 当直帯に体液検体の報告が必要": document.getElementById('q12-1').checked ? "はい" : "いいえ",
                "Q13. 体液の鏡検者の不足またはスキル継続に課題がある": document.getElementById('q13-1').checked ? "はい" : "いいえ",
                "Q14. 標本枚数/日": document.getElementById('q14').value || "未回答",
                "Q15. 現在、血液像自動分析装置の有無": document.getElementById('q15').value || "未回答",
                "Q16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい": document.getElementById('q16-1').checked ? "はい" : "いいえ",
                "Q17. 検査室内での鏡検スキルの平準化を進めたい": document.getElementById('q17-1').checked ? "はい" : "いいえ",
                "Q18. SPないしDIが複数台数あるか": document.getElementById('q18').value || "未回答",
                "Q19. 設置面積をできる限り狭くしたいか": document.getElementById('q19').value || "未回答",
                "Q20. TS-10の検体回収作業を端で行いたいか": document.getElementById('q20').value || "未回答",
                "Q21. 血液・凝固検査を含めた自動化を進めたい": document.getElementById('q21-1').checked ? "はい" : "いいえ",
                "Q22. 血液・凝固検査の担当人員を減らしたい": document.getElementById('q22-1').checked ? "はい" : "いいえ",
                "Q23. 夜間当直帯の装置オペレーションを少なくしたい": document.getElementById('q23-1').checked ? "はい" : "いいえ"
            };

            // 結果を取得
            const resultText = document.getElementById('result').innerText.trim();
            const fullText = "【質問と回答】\n" + Object.entries(qa).map(([q, a]) => `${q}: ${a}`).join('\n') + 
                           "\n\n【分析結果】\n" + resultText;

            if (exportFormat === 'csv') {
                exportAsCSV(qa, resultText);
            } else if (exportFormat === 'txt') {
                exportAsText(fullText);
            } else if (exportFormat === 'xls') {
                exportAsExcel(qa, resultText);
            } else if (exportFormat === 'json') {
                exportAsJSON(qa, resultText);
            } else {
                alert('エクスポート形式を選択してください');
            }
        }

        function exportAsCSV(qa, resultText) {
            let csvLines = [];
            // 質問と回答
            csvLines.push('"セクション","項目","回答"');
            csvLines.push('"質問と回答"');
            for (let [q, a] of Object.entries(qa)) {
                csvLines.push(`"質問","${q}","${a}"`);
            }
            // 分析結果
            csvLines.push('"分析結果"');
            resultText.split('\n').forEach(line => {
                const parts = line.trim().split(':');
                if (parts.length === 2) {
                    csvLines.push(`"結果","${parts[0].trim()}","${parts[1].trim()}"`);
                }
            });
            
            const blob = new Blob(["\ufeff" + csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsText(text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsExcel(qa, resultText) {
            let tableHTML = '<table border="1" style="border-collapse:collapse;">';
            // 質問と回答
            tableHTML += '<tr><th colspan="2">質問と回答</th></tr>';
            for (let [q, a] of Object.entries(qa)) {
                tableHTML += `<tr><td>${q}</td><td>${a}</td></tr>`;
            }
            // 分析結果
            tableHTML += '<tr><th colspan="2">分析結果</th></tr>';
            resultText.split('\n').forEach(line => {
                const parts = line.trim().split(':');
                if (parts.length === 2) {
                    tableHTML += `<tr><td>${parts[0].trim()}</td><td>${parts[1].trim()}</td></tr>`;
                }
            });
            tableHTML += '</table>';

            const blob = new Blob(["\ufeff" + tableHTML], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.xls';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsJSON(qa, resultText) {
            const resultObj = {};
            resultText.split('\n').forEach(line => {
                const parts = line.trim().split(':');
                if (parts.length === 2) {
                    resultObj[parts[0].trim()] = parts[1].trim();
                }
            });

            const fullData = {
                "質問と回答": qa,
                "分析結果": resultObj
            };

            const jsonString = JSON.stringify(fullData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function autoSaveForm() {
            const formData = {};
            document.querySelectorAll('input, select').forEach(element => {
                if (element.type === 'checkbox') {
                    formData[element.id] = element.checked;
                } else {
                    formData[element.id] = element.value;
                }
            });
            sessionStorage.setItem('formData', JSON.stringify(formData));
        }

        function loadAutoSavedForm() {
            const savedData = sessionStorage.getItem('formData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                Object.entries(formData).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });
            }
        }

        // 入力フィールドの変更を監視
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', autoSaveForm);
        });

        // スプラッシュスクリーン
        window.onload = function() {
            const splashScreen = document.getElementById('splashScreen');
            const mainContent = document.getElementById('mainContent');
            // 2秒後にフェードアウト
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    // アイコン描画
                    lucide.createIcons();
                }, 500);
            }, 2000);
        };
    </script>
</body>
</html>
