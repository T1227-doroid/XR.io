<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XR-9000構成アプリケーション</title>
    <!-- Icon library (Lucide) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="config.js"></script>
    <!-- Mermaid.js の追加 -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        /* 基本デザインをスタイリッシュに */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            background-color: #f9fafb;
            color: #1f2937;
            display: flex;
            height: 100vh;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        /* コンテナとスプラッシュ */
        .container {
            display: none;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        .splash-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #fff;
            z-index: 1000;
            transition: opacity 1s ease-out;
        }
        .splash-screen img {
            max-width: 100%;
            max-height: 100%;
        }
        /* 左パネル(質問) */
        .questions {
            width: 35%;
            padding: 20px;
            background-color: #fff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            position: relative;
            height: calc(100vh - 40px);
            padding-bottom: 120px; /* 下部の余白を増やす */
        }
        .logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 80px;
            height: auto;
            display: block;
            margin: 0 auto;
            margin-bottom: 10px;
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .app-title {
            text-align: center;
            margin: 20px 0;
            font-size: 1.4rem;
            font-weight: 700;
            color: #1f2937;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 28px;
            margin-bottom: 16px;
            color: var(--gray-800);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        .question {
            background-color: var(--gray-50);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            transform: translateX(-20px);
            opacity: 0;
            animation: slideIn 0.5s forwards;
        }
        .question:hover {
            background-color: var(--gray-100);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .question label {
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
        }
        .question input[type="number"],
        .question select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #fff;
            color: #1f2937;
        }
        .question input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            transition: transform 0.2s ease;
        }
        .checkbox-container:hover {
            transform: translateX(4px);
        }
        /* 右パネル(結果) */
        .results {
            width: 65%;
            padding: 20px;
            background-color: #fff;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            overflow-y: auto;
            height: 100vh;
        }
        .result-section {
            width: 100%;
            margin-bottom: 20px;
        }
        .result {
            margin-top: 16px;
            background-color: var(--gray-50);
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8;
            white-space: pre-wrap;
            border: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out;
        }
        /* 結果テキストの余白調整 */
        #result, #modalResult {
            white-space: pre-wrap;
            margin: 0;
            padding: 0;
        }
        .image-section {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
        }
        .image-section img {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .image-section img:hover {
            transform: scale(1.02);
        }
        /* ボタン類 */
        .button-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px 16px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .icon-button:hover {
            background-color: #2563eb;
        }
        .icon-button:active {
            transform: scale(0.98);
        }
        /* 動画エリア */
        .video-section {
            width: 100%;
            margin-top: 20px;
            position: relative;
            padding-top: 56.25%; /* 16:9のアスペクト比を維持 */
        }
        .video-section iframe {
            width: 100%;
            border: none;
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }
        /* エクスポート */
        .export-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .export-select {
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #1f2937;
            min-width: 100px;
        }
        /* モーダル関連 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            width: 95%;
            max-width: 1800px;
            max-height: 95vh;
            border-radius: 8px;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        .close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 24px;
            font-weight: bold;
            color: #4b5563;
            cursor: pointer;
        }
        .close:hover {
            color: #1f2937;
        }
        /* YouTubeセクション：XR-9000紹介 */
        .youtube-section {
            width: 100%;
            margin-top: 30px;
            position: relative;
            padding-top: 56.25%; /* 16:9のアスペクト比を維持 */
        }
        .youtube-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1f2937;
        }
        .youtube-section iframe {
            width: 100%;
            border: none;
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --secondary: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --dark-bg: #1a1a1a;
            --dark-text: #e5e7eb;
            --dark-surface: #2d2d2d;
            --mermaid-node-spacing: 100px;
            --mermaid-rank-spacing: 80px;
            --header-color: #3b82f6;  /* 会話要約ヘッダーの色 */
            --button-hover: #2563eb;  /* ホバー時の色 */
        }

        .icon-button {
            background-color: var(--primary);
        }
        .icon-button:hover {
            background-color: var(--primary-hover);
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
            }
            .questions, .results {
                width: 100%;
                height: auto;
                padding: 16px;
                padding-bottom: 300px; /* さらに余白を増やす */
            }
            .app-title {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }
            .logo {
                width: 60px;
            }

            /* iPadの横向き表示対応 */
            @media (orientation: landscape) {
                .questions {
                    max-height: none; /* 高さ制限を解除 */
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                    padding-bottom: 400px; /* 横向き時の余白をさらに増やす */
                }
                
                .question {
                    margin-bottom: 16px;
                    padding: 16px;
                }
                
                .section-title {
                    margin-top: 20px;
                    margin-bottom: 12px;
                }
                
                /* 最後の質問の下部余白を確保 */
                .question:last-child {
                    margin-bottom: 200px;
                }
            }

            /* スクロール時の慣性スクロールを有効化 */
            body {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
        }

        @media (max-width: 640px) {
            .button-container {
                flex-direction: column;
                gap: 8px;
            }
            .icon-button {
                width: 100%;
                justify-content: center;
                padding: 12px;
            }
            .question {
                padding: 12px;
            }
            .section-title {
                font-size: 1rem;
                margin-top: 20px;
                margin-bottom: 12px;
            }
            .result {
                padding: 16px;
                font-size: 0.9rem;
            }
            .image-section img {
                max-height: 300px;
            }
            .video-section iframe,
            .youtube-section iframe {
                height: 240px;
            }
            .export-container {
                flex-direction: column;
                gap: 8px;
            }
            .export-select {
                width: 100%;
            }
            /* モーダルの調整 */
            .modal-content {
                margin: 10px;
                padding: 16px;
            }
        }

        @media print {
            .questions {
                width: 100%;
                height: auto;
            }
            .results {
                width: 100%;
                height: auto;
                page-break-before: always;
            }
            .button-container,
            .video-section,
            .youtube-section {
                display: none;
            }
            .result {
                border: 1px solid #000;
            }
            .image-section img {
                max-height: 500px;
            }
        }

        /* エラーメッセージのスタイル */
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 4px;
        }

        /* 入力フィールドのバリデーション表示 */
        .question input:invalid {
            border-color: #dc2626;
            background-color: #fef2f2;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--dark-bg);
                color: var(--dark-text);
            }
            .questions, .results {
                background-color: var(--dark-surface);
            }
            .question {
                background-color: rgba(255, 255, 255, 0.05);
            }
            .result {
                background-color: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }
        }

        /* 質問セクションのアニメーション */
        @keyframes slideIn {
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 結果表示のアニメーション */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            padding: 5px 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 1.2rem;
            }
            .section-title {
                font-size: 1rem;
            }
            .export-container {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 60px;
            }
            .export-select {
                margin-bottom: 8px;
                width: 100%;
            }
            .result-card {
                margin: 10px;
            }
            
            .result-item {
                flex-direction: column;
                gap: 4px;
            }
            
            .image-section img {
                max-height: 300px;
            }
            
            .quick-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: white;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.1)
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            to {
                background-position: -200% 0;
            }
        }

        .quick-nav {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-200);
        }
        .nav-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--gray-200);
        }
        /* 入力フィールドのフォーカス効果を改善 */
        .question input:focus,
        .question select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* チェックボックスをカスタマイズ */
        .custom-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray-300);
            border-radius: 4px;
            margin-right: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 結果セクションのカード化 */
        .result-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .result-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .result-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* データモーダルのスタイル */
        .data-actions {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 20px 0;
        }
        
        .export-section,
        .import-section {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 8px;
        }
        
        .export-section h3,
        .import-section h3 {
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--gray-800);
        }
        
        #importFile {
            display: none;
        }

        /* iPadのスクロールバーのスタイリング */
        .questions::-webkit-scrollbar {
            width: 8px;
        }
        
        .questions::-webkit-scrollbar-track {
            background: var(--surface);
        }
        
        .questions::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .voice-hearing-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .voice-hearing-section.hidden {
            margin: 0;
            padding: 0;
            height: 0;
            opacity: 0;
            overflow: hidden;
            border: none;
        }

        .recording-status {
            margin: 10px 0;
            color: var(--text-light);
        }

        .summary-container {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
        }
        
        .summary-container.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        .toggle-button i {
            transition: transform 0.3s ease;
        }

        .toggle-button.collapsed i {
            transform: rotate(180deg);
        }

        /* 会話要約セクションのスライド表示 */
        .voice-hearing-section {
            position: fixed;
            top: 0;
            right: -500px;  /* 完全に画面外に配置（余裕を持って） */
            width: 460px;   /* デスクトップでの表示幅 */
            height: 100vh;
            background: white;
            border-left: 1px solid var(--border);
            transition: right 0.4s ease-in-out;
            z-index: 2100;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }

        .voice-hearing-section.visible {
            right: 0;
            box-shadow: -3px 0 15px rgba(0, 0, 0, 0.15);
        }

        /* 会話要約トグルボタン */
        #voiceToggleButton {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 2200;  /* 常に最前面に */
            width: 60px;
            height: 60px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 1.5em;
            transition: all 0.3s ease;
            background: var(--header-color);
            color: white;
            border: none;
            cursor: pointer;
        }

        #voiceToggleButton:hover,
        #logicChartButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            background: var(--button-hover);
        }

        /* 会話要約ヘッダー */
        .section-header {
            padding: 15px;
            background: var(--header-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            margin: 0;
        }

        /* モバイル対応のスタイル */
        @media (max-width: 768px) {
            .voice-hearing-section {
                width: 100%;
                right: -120vw;  /* 確実に画面外に配置 */
                max-width: 100%;
            }
            
            .summary-container {
                margin: 6px;
                padding: 8px;
                height: calc(100vh - 80px);
            }
            
            .summary-item {
                width: 100%;
                box-sizing: border-box;
            }
            
            .conversation-text pre {
                white-space: pre-wrap;
                word-break: break-word;
            }

            #voiceToggleButton,
            #logicChartButton {
                right: 10px;
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            #logicChartButton {
                bottom: 80px;
            }
        }

        @media (max-width: 320px) {
            .voice-hearing-section {
                width: 100%;
                right: -130vw;  /* iPhone SEでも確実に画面外に */
            }

            .summary-container {
                margin: 6px;
                padding: 8px;
            }

            .conversation-text,
            .summary-text {
                font-size: 12px;
            }
        }

        .summary-item {
            border-left: 3px solid var(--primary);
            margin-bottom: 15px;
            padding: 10px;
            background: var(--surface);
            border-radius: 4px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-time {
            font-size: 0.8em;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .summary-text {
            white-space: pre-wrap;
            line-height: 1.5;
        }

        /* スクロール可能な要約コンテンツエリア */
        #conversationSummary {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* スクロールバーのスタイリング */
        #conversationSummary::-webkit-scrollbar {
            width: 8px;
        }
        
        #conversationSummary::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 4px;
        }
        
        #conversationSummary::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        #conversationSummary::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        .conversation-text {
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
        }
        
        .conversation-text pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: inherit;
        }

        .summary-text {
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .voice-hearing-section {
                width: 100%;
                right: -100vw;
            }
        }

        /* 最新の要約をハイライト */
        .summary-item.latest {
            border-left: 4px solid var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }

        /* スクロールバーのスタイリング改善 */
        .conversation-text::-webkit-scrollbar,
        .summary-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .conversation-text::-webkit-scrollbar-track,
        .summary-container::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 4px;
        }
        
        .conversation-text::-webkit-scrollbar-thumb,
        .summary-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .summary-item {
            scroll-margin-top: 20px; /* スクロール時の余白 */
        }

        .latest {
            animation: highlight 1s ease;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.2); }
            100% { background-color: rgba(59, 130, 246, 0.05); }
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .export-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1100;
        }

        .export-menu-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-menu button {
            padding: 10px 20px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .export-menu button:hover {
            background: var(--primary-hover);
        }

        /* ロジックチャートボタンのスタイル */
        #logicChartButton {
            position: fixed;
            right: 20px;
            bottom: 88px;  /* 20px + 56px + 12px(間隔) */
            z-index: 2200;  /* 常に最前面に */
            width: 60px;
            height: 60px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 1.5em;
            transition: all 0.3s ease;
            background: var(--header-color);
            color: white;
            border: none;
            cursor: pointer;
        }

        /* モーダルのスタイル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            width: 95%;
            max-width: 1800px;
            max-height: 95vh;
            border-radius: 8px;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-header button {
            background: transparent;
            border: none;
            color: white;
        }

        .modal-body {
            flex-grow: 1;
            overflow: auto;
            padding: 10px;
            display: flex;
            justify-content: center;
        }

        .mermaid {
            width: 100%;
            height: 100%;
            min-height: 800px;
            background: white;
            transform-origin: top left;
            transform: scale(1.4);
            margin: 20px;
            padding: 20px;
        }

        /* スクロールバーのスタイル */
        .modal-body::-webkit-scrollbar {
            width: 12px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 6px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }

        /* フローチャートの配置調整 */
        #logicChartContent {
            width: 100%;
            overflow-x: auto;
            padding: 20px;
        }

        /* フローチャートのノード間隔調整 */
        :root {
            --mermaid-node-spacing: 100px;
            --mermaid-rank-spacing: 80px;
        }

        /* 共通ボタンスタイル */
        .icon-only-button {
            background: var(--header-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-only-button:hover {
            background: var(--button-hover);
        }

        /* 固定ボタンのベーススタイル - 他のスタイルをすべて上書き */
        .fixed-button {
            position: fixed !important;
            right: 20px !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 28px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            font-size: 1.4em !important;
            z-index: 2200 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: var(--header-color) !important;
            color: white !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }

        /* ボタンの位置指定 */
        #voiceToggleButton {
            bottom: 20px !important;
        }

        #logicChartButton {
            bottom: 88px !important;
        }

        /* モバイル対応 */
        @media (max-width: 768px) {
            .fixed-button {
                right: 16px !important;
                width: 48px !important;
                height: 48px !important;
                font-size: 1.1em !important;
            }

            #logicChartButton {
                bottom: 80px !important;
            }
        }

        /* すべてのボタンの共通スタイル */
        button {
            background: var(--header-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 4px;
        }

        button:hover {
            background: var(--button-hover);
        }

        /* 結果表示ボタン */
        #calculateButton {
            font-size: 1.1em;
            font-weight: bold;
            padding: 12px 24px;
        }

        /* データ入出力ボタン */
        .data-io-buttons button {
            margin: 5px;
        }

        /* モーダル内のボタン */
        .modal-header button {
            background: transparent;
        }

        .modal-header button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 会話要約コンテンツのスタイル調整 */
        .summary-container {
            margin: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            height: calc(100vh - 100px);
            width: calc(100% - 20px);
            box-sizing: border-box;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .voice-hearing-section {
                width: 100%;
                right: -100vw;
            }
            
            .summary-container {
                margin: 8px;
                padding: 10px;
                height: calc(100vh - 80px);
            }
        }
    </style>
</head>
<body>
    <!-- スプラッシュスクリーン -->
    <div class="splash-screen" id="splashScreen">
        <img id="splashImage" src="images/background.png" alt="Background Image">
    </div>

    <!-- メインコンテナ -->
    <div class="container" id="mainContent">
        <!-- 左パネル：質問 -->
        <div class="questions">
            <img src="images/logo.png" alt="Logo" class="logo">
            <h1 class="app-title gradient-text">XR-9000構成アプリケーション</h1>

            <div class="section-title">1-1 XRモジュール台数</div>
            <div class="question">
                <label for="q1">1. 1日の検体数は？</label>
                <input type="number" id="q1" min="0" placeholder="例: 800">
            </div>
            <div class="question">
                <label for="q2">2. 1時間当たりの最大検体数は？</label>
                <input type="number" id="q2" min="0" placeholder="例: 100">
            </div>

            <div class="section-title">1-2 ツイン/シングルモジュールの選択</div>
            <div class="question">
                <label for="q3">3. 別号機再検の希望は？</label>
                <select id="q3">
                    <option value="あり">あり</option>
                    <option value="なし">なし</option>
                </select>
            </div>

            <div class="section-title">1-3 濃縮試薬(RU)の選択</div>
            <div class="checkbox-container">
                <label for="q4-1">4. セルパックの交換頻度を減らしたい</label>
                <input type="checkbox" id="q4-1">
            </div>
            <div class="checkbox-container">
                <label for="q5-1">5. セルパックの在庫スペースを削減したい</label>
                <input type="checkbox" id="q5-1">
            </div>

            <div class="section-title">1-4 オプションチャンネルの有無</div>
            <div class="checkbox-container">
                <label for="q6-1">6. 造血幹細胞移植をしている</label>
                <input type="checkbox" id="q6-1">
            </div>
            <div class="checkbox-container">
                <label for="q7-1">7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい</label>
                <input type="checkbox" id="q7-1">
            </div>
            <div class="checkbox-container">
                <label for="q8-1">8. IPFの臨床要望がある</label>
                <input type="checkbox" id="q8-1">
            </div>
            <div class="checkbox-container">
                <label for="q9-1">9. PLT 5万以下の検体数が多い</label>
                <input type="checkbox" id="q9-1">
            </div>
            <div class="checkbox-container">
                <label for="q10-1">10. 破砕赤血球の出現検体が時々ある</label>
                <input type="checkbox" id="q10-1">
            </div>

            <div class="section-title">1-5 体液の機械値報告をしたい</div>
            <div class="checkbox-container">
                <label for="q11-1">11. 体液の機械値報告をしたい</label>
                <input type="checkbox" id="q11-1">
            </div>
            <div class="checkbox-container">
                <label for="q12-1">12. 当直帯に体液検体の報告が必要</label>
                <input type="checkbox" id="q12-1">
            </div>
            <div class="checkbox-container">
                <label for="q13-1">13. 体液の鏡検者の不足またはスキル継続に課題がある</label>
                <input type="checkbox" id="q13-1">
            </div>

            <div class="section-title">2-1 SP-50の台数</div>
            <div class="question">
                <label for="q14">14. 標本枚数/日は？</label>
                <input type="number" id="q14" min="0" placeholder="例: 150">
            </div>

            <div class="section-title">3-1 DI-60の有無</div>
            <div class="question">
                <label for="q15">15. 現在、血液像自動分析装置の有無は？</label>
                <select id="q15">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="checkbox-container">
                <label for="q16-1">16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい</label>
                <input type="checkbox" id="q16-1">
            </div>
            <div class="checkbox-container">
                <label for="q17-1">17. 検査室内での鏡検スキルの平準化を進めたい</label>
                <input type="checkbox" id="q17-1">
            </div>

            <div class="section-title">4-1 TS-10の位置(先頭, 真ん中, 最後尾)</div>
            <div class="question">
                <label for="q18">18. SPないしDIが複数台数あるか？</label>
                <select id="q18">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="question">
                <label for="q19">19. 設置面積をできる限り狭くしたいか？</label>
                <select id="q19">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>
            <div class="question">
                <label for="q20">20. TS-10の検体回収作業を端で行いたいか？</label>
                <select id="q20">
                    <option value="なし">なし</option>
                    <option value="あり">あり</option>
                </select>
            </div>

            <div class="section-title">5-1 血液・凝固検査の効率化</div>
            <div class="checkbox-container">
                <label for="q21-1">21. 血液・凝固検査を含めた自動化を進めたい</label>
                <input type="checkbox" id="q21-1">
            </div>
            <div class="checkbox-container">
                <label for="q22-1">22. 血液・凝固検査の担当人員を減らしたい</label>
                <input type="checkbox" id="q22-1">
            </div>
            <div class="checkbox-container">
                <label for="q23-1">23. 夜間当直帯の装置オペレーションを少なくしたい</label>
                <input type="checkbox" id="q23-1">
            </div>
        </div>

        <!-- 右パネル：結果 -->
        <div class="results">
            <!-- ボタンコンテナ -->
            <div class="button-container">
                <button class="icon-button" onclick="calculateResult()">
                    <i data-lucide="play-circle"></i>
                    結果表示
                </button>
                <button class="icon-button" onclick="openDataModal()">
                    <i data-lucide="file-input"></i>
                    データ入出力
                </button>
            </div>

            <div class="result-section">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">ご提案構成イメージ</h3>
                <h4 style="margin-top: 4px; color: #6b7280; font-weight: 400;">※ST-40、ST-41の配置は参考です。</h4>
                <div class="result" id="result"></div>
            </div>
            <div class="image-section">
                <img id="patternImage" src="" alt="">
            </div>
            <!-- Vimeo動画 -->
            <div class="video-section" id="videoContainer"></div>

            <!-- XR-9000紹介：YouTube -->
            <div class="youtube-section">
                <iframe src="https://www.youtube.com/embed/_S8trQsU-J0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- 結果モーダル -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalResult"></div>
            <div class="image-section">
                <img id="modalPatternImage" src="" alt="">
            </div>
        </div>
    </div>

    <!-- インポート・エクスポートモーダル -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDataModal()">&times;</span>
            <h2>データのインポート・エクスポート</h2>
            <div class="data-actions">
                <div class="export-section">
                    <h3>エクスポート</h3>
                    <select id="exportSelect" class="export-select">
                        <option value="">エクスポート形式を選択</option>
                        <option value="csv">CSV形式</option>
                        <option value="txt">テキスト形式</option>
                        <option value="json">JSON形式</option>
                    </select>
                    <button class="icon-button" onclick="exportResult()">
                        <i data-lucide="download"></i>
                        エクスポート
                    </button>
                </div>
                <div class="import-section">
                    <h3>インポート</h3>
                    <input type="file" id="importFile" accept=".json,.csv,.txt,.xls">
                    <button class="icon-button" onclick="document.getElementById('importFile').click()">
                        <i data-lucide="upload"></i>
                        ファイルを選択
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 会話要約表示切替ボタン -->
    <button class="icon-only-button fixed-button" onclick="toggleVoiceSection()" id="voiceToggleButton" title="会話要約の表示/非表示">
        <i class="fas fa-comments"></i>
    </button>

    <!-- 音声ヒアリング機能の追加 -->
    <div class="voice-hearing-section" id="voiceSection">
        <div class="section-header">
            <h3>会話要約</h3>
            <div class="header-buttons">
                <button class="icon-only-button" onclick="exportConversation()" title="会話内容をエクスポート">
                    <i class="fas fa-download"></i>
                </button>
                <button class="icon-only-button" onclick="toggleVoiceSection()" title="閉じる">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="summary-container" id="summaryContainer">
            <button class="icon-only-button" onclick="startVoiceRecording()" id="recordButton" title="音声録音開始">
                <i class="fas fa-microphone"></i>
            </button>
            <div class="recording-status" id="recordingStatus"></div>
            <div id="conversationSummary" class="summary-content"></div>
        </div>
    </div>

    <!-- ロジックチャート表示ボタン -->
    <button class="icon-only-button fixed-button" onclick="toggleLogicChart()" id="logicChartButton" title="ロジックチャート表示">
        <i class="fas fa-sitemap"></i>
    </button>

    <!-- ロジックチャートモーダル -->
    <div id="logicChartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>構成パターン判定ロジック</h2>
                <button class="icon-only-button" onclick="toggleLogicChart()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="logicChartContent" class="logic-chart"></div>
            </div>
        </div>
    </div>

    <script>
        /*
          lucideアイコンの描画初期化
        */
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        function calculateResult() {
            const q1 = parseInt(document.getElementById('q1').value) || 0;
            const q2 = parseInt(document.getElementById('q2').value) || 0;
            const q3 = document.getElementById('q3').value;
            const q4 = document.getElementById('q4-1').checked;
            const q5 = document.getElementById('q5-1').checked;
            const q6 = document.getElementById('q6-1').checked;
            const q7 = document.getElementById('q7-1').checked;
            const q8 = document.getElementById('q8-1').checked;
            const q9 = document.getElementById('q9-1').checked;
            const q10 = document.getElementById('q10-1').checked;
            const q11 = document.getElementById('q11-1').checked;
            const q12 = document.getElementById('q12-1').checked;
            const q13 = document.getElementById('q13-1').checked;
            const q14 = parseInt(document.getElementById('q14').value) || 0;
            const q15 = document.getElementById('q15').value;
            const q16 = document.getElementById('q16-1').checked;
            const q17 = document.getElementById('q17-1').checked;
            const q18 = document.getElementById('q18').value;
            const q19 = document.getElementById('q19').value;
            const q20 = document.getElementById('q20').value;
            const q21 = document.getElementById('q21-1').checked;
            const q22 = document.getElementById('q22-1').checked;
            const q23 = document.getElementById('q23-1').checked;

            let xrCount1;
            if (q1 >= 1200) {
                xrCount1 = 6;
            } else if (q1 >= 1000) {
                xrCount1 = 5;
            } else if (q1 >= 800) {
                xrCount1 = 4;
            } else if (q1 >= 600) {
                xrCount1 = 3;
            } else {
                xrCount1 = 2;
            }

            let xrCount2;
            if (q2 >= 400) {
                xrCount2 = 5;
            } else if (q2 >= 300) {
                xrCount2 = 4;
            } else if (q2 >= 200) {
                xrCount2 = 3;
            } else if (q2 >= 100) {
                xrCount2 = 2;
            } else {
                xrCount2 = 1;
            }

            const xrCount = Math.max(xrCount1, xrCount2);

            let moduleType;
            if (q3 === 'あり' && xrCount % 2 === 0) {
                moduleType = 'ツインモジュール';
            } else {
                moduleType = 'シングルモジュール';
            }

            let ru = (q4 || q5) ? 'RUあり' : 'RUなし';
            let wpc = (q6 || q7) ? 'WPCチャンネルあり(XR-20)' : 'WPCチャンネルなし(XR-10)';
            let pltF = (q8 || q9 || q10) ? 'PLT-Fチャンネルあり' : 'PLT-Fチャンネルなし';
            let bf = (q11 || q12 || q13) ? 'BFモードあり' : 'BFモードなし';

            let sp50 = (q14 < 150) ? 'SP-50 1台' : 'SP-50 2台';
            let di60 = (q15 === 'あり' || q16 || q17) ? 'DI-60あり' : 'DI-60なし';

            let ts10;
            if (q20 === 'あり') {
                ts10 = 'TS-10最後尾配置';
            } else {
                ts10 = 'TS-10中央配置';
            }

            let bloodScience = (q21 || q22 || q23) ? 'BloodScience Workcellの提案' : 'BloodScience Workcellなし';

            // 最終構成パターン図番号の計算
let patternNumber = 0;
if (xrCount === 2) {
    if (moduleType === 'ツインモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 1 : 2;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 3 : 4;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 5 : 6;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 7 : 8;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 9 : 10;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 11 : 12;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 13 : 14;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 15 : 16;
                }
            }
        }
    } else {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 17 : 18;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 19 : 20;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 21 : 22;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 23 : 24;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 25 : 26;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 27 : 28;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 29 : 30;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 31 : 32;
                }
            }
        }
    }
} else if (xrCount === 4) {
    if (moduleType === 'ツインモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 33 : 34;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 35 : 36;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 37 : 38;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 39 : 40;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 41 : 42;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 43 : 44;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 45 : 46;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 47 : 48;
                }
            }
        }
    } else {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 49 : 50;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 51 : 52;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 53 : 54;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 55 : 56;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 57 : 58;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 59 : 60;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 61 : 62;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 63 : 64;
                }
            }
        }
    }
} else if (xrCount === 6) {
    if (moduleType === 'ツインモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 65 : 66;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 67 : 68;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 69 : 70;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 71 : 72;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 73 : 74;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 75 : 76;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 77 : 78;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 79 : 80;
                }
            }
        }
    } else {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 81 : 82;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 83 : 84;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 85 : 86;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 87 : 88;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 89 : 90;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 91 : 92;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 93 : 94;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 95 : 96;
                }
            }
        }
    }
} else if (xrCount === 3) {
    if (moduleType === 'シングルモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 97 : 98;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 99 : 100;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 101 : 102;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 103 : 104;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 105 : 106;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 107 : 108;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 109 : 110;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 111 : 112;
                }
            }
        }
    }
} else if (xrCount === 5) {
    if (moduleType === 'シングルモジュール') {
        if (ru === 'RUあり') {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 113 : 114;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 115 : 116;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 117 : 118;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 119 : 120;
                }
            }
        } else {
            if (sp50 === 'SP-50 1台') {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 121 : 122;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 123 : 124;
                }
            } else {
                if (di60 === 'DI-60なし') {
                    patternNumber = ts10 === 'TS-10中央配置' ? 125 : 126;
                } else {
                    patternNumber = ts10 === 'TS-10中央配置' ? 127 : 128;
                }
            }
        }
    }
}

            // 出力
            document.getElementById('result').innerText = `XRモジュール台数: ${xrCount}台\nモジュールタイプ: ${moduleType}\n濃縮試薬(RU): ${ru}\nWPCチャンネル: ${wpc}\nPLT-Fチャンネル: ${pltF}\nBFモード: ${bf}\nSP-50数: ${sp50}\nDI-60: ${di60}\nTS-10の位置: ${ts10}\nBloodScience Workcell: ${bloodScience}\n最終構成パターン図番号: ${patternNumber}`;

            // パターン番号に応じた画像
            const patternImage = document.getElementById('patternImage');
            patternImage.src = `images/pattern${patternNumber}.png`;
            patternImage.alt = `構成パターン図 ${patternNumber}`;

            // 動画の埋め込み
            const videoContainer = document.getElementById('videoContainer');
            if (q21 || q22 || q23) {
                // BloodScience Workcellに関する動画
                videoContainer.innerHTML = `\n<iframe src="https://player.vimeo.com/video/843146377" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = "";
            }

            // モーダルにも反映
            document.getElementById('modalResult').innerText = document.getElementById('result').innerText;
            const modalPatternImage = document.getElementById('modalPatternImage');
            modalPatternImage.src = patternImage.src;
            modalPatternImage.alt = patternImage.alt;
        }

        function openDataModal() {
            document.getElementById('dataModal').style.display = 'block';
        }

        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const resultModal = document.getElementById('resultModal');
            const dataModal = document.getElementById('dataModal');
            if (event.target === resultModal) {
                resultModal.style.display = 'none';
            } else if (event.target === dataModal) {
                dataModal.style.display = 'none';
            }
        }

        // エクスポート
        function exportResult() {
            calculateResult();
            const exportFormat = document.getElementById('exportSelect').value;
            
            // 質問と回答を収集
            const qa = {
                "Q1. 1日の検体数": document.getElementById('q1').value,
                "Q2. 1時間当たりの最大検体数": document.getElementById('q2').value,
                "Q3. 別号機再検の希望": document.getElementById('q3').value,
                "Q4. セルパックの交換頻度を減らしたい": document.getElementById('q4-1').checked ? "はい" : "いいえ",
                "Q5. セルパックの在庫スペースを削減したい": document.getElementById('q5-1').checked ? "はい" : "いいえ",
                "Q6. 造血幹細胞移植をしている": document.getElementById('q6-1').checked ? "はい" : "いいえ",
                "Q7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい": document.getElementById('q7-1').checked ? "はい" : "いいえ",
                "Q8. IPFの臨床要望がある": document.getElementById('q8-1').checked ? "はい" : "いいえ",
                "Q9. PLT 5万以下の検体数が多い": document.getElementById('q9-1').checked ? "はい" : "いいえ",
                "Q10. 破砕赤血球の出現検体が時々ある": document.getElementById('q10-1').checked ? "はい" : "いいえ",
                "Q11. 体液の機械値報告をしたい": document.getElementById('q11-1').checked ? "はい" : "いいえ",
                "Q12. 当直帯に体液検体の報告が必要": document.getElementById('q12-1').checked ? "はい" : "いいえ",
                "Q13. 体液の鏡検者の不足またはスキル継続に課題がある": document.getElementById('q13-1').checked ? "はい" : "いいえ",
                "Q14. 標本枚数/日": document.getElementById('q14').value,
                "Q15. 現在、血液像自動分析装置の有無": document.getElementById('q15').value,
                "Q16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい": document.getElementById('q16-1').checked ? "はい" : "いいえ",
                "Q17. 検査室内での鏡検スキルの平準化を進めたい": document.getElementById('q17-1').checked ? "はい" : "いいえ",
                "Q18. SPないしDIが複数台数あるか": document.getElementById('q18').value,
                "Q19. 設置面積をできる限り狭くしたいか": document.getElementById('q19').value,
                "Q20. TS-10の検体回収作業を端で行いたいか": document.getElementById('q20').value,
                "Q21. 血液・凝固検査を含めた自動化を進めたい": document.getElementById('q21-1').checked ? "はい" : "いいえ",
                "Q22. 血液・凝固検査の担当人員を減らしたい": document.getElementById('q22-1').checked ? "はい" : "いいえ",
                "Q23. 夜間当直帯の装置オペレーションを少なくしたい": document.getElementById('q23-1').checked ? "はい" : "いいえ"
            };
            
            const resultText = document.getElementById('result').innerText;
            const fullText = "【質問と回答】\n" + 
                Object.entries(qa).map(([q, a]) => `${q}: ${a}`).join('\n') + 
                "\n\n【分析結果】\n" + resultText;

            if (exportFormat === 'csv') {
                exportAsCSV(qa, resultText);
            } else if (exportFormat === 'txt') {
                exportAsText(fullText);
            } else if (exportFormat === 'json') {
                exportAsJSON(qa, resultText);
            } else {
                alert('エクスポート形式を選択してください');
            }
        }

        function exportAsCSV(qa, resultText) {
            let csvLines = [];
            // 質問と回答
            csvLines.push('"セクション","項目","回答"');
            csvLines.push('"質問と回答"');
            for (let [q, a] of Object.entries(qa)) {
                csvLines.push(`"質問","${q}","${a}"`);
            }
            // 分析結果
            csvLines.push('"分析結果"');
            resultText.split('\n').forEach(line => {
                const parts = line.trim().split(':');
                if (parts.length === 2) {
                    csvLines.push(`"結果","${parts[0].trim()}","${parts[1].trim()}"`);
                }
            });
            
            const blob = new Blob(["\ufeff" + csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsText(text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsJSON(qa, resultText) {
            const resultObj = {};
            resultText.split('\n').forEach(line => {
                const parts = line.trim().split(':');
                if (parts.length === 2) {
                    resultObj[parts[0].trim()] = parts[1].trim();
                }
            });

            const fullData = {
                "質問と回答": qa,
                "分析結果": resultObj
            };

            const jsonString = JSON.stringify(fullData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_result.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function autoSaveForm() {
            const formData = {};
            document.querySelectorAll('input, select').forEach(element => {
                if (element.type === 'checkbox') {
                    formData[element.id] = element.checked;
                } else {
                    formData[element.id] = element.value;
                }
            });
            sessionStorage.setItem('formData', JSON.stringify(formData));
        }

        function loadAutoSavedForm() {
            const savedData = sessionStorage.getItem('formData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                Object.entries(formData).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });
            }
        }

        // 入力フィールドの変更を監視
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', autoSaveForm);
        });

        // スプラッシュスクリーン
        window.onload = function() {
            const splashScreen = document.getElementById('splashScreen');
            const mainContent = document.getElementById('mainContent');
            // 2秒後にフェードアウト
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    // アイコン描画
                    lucide.createIcons();
                }, 500);
            }, 2000);
        };

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const extension = file.name.split('.').pop().toLowerCase();
                    switch(extension) {
                        case 'json':
                            importJSON(e.target.result);
                            break;
                        case 'csv':
                            importCSV(e.target.result);
                            break;
                        case 'txt':
                            importTXT(e.target.result);
                            break;
                        case 'xls':
                            importXLS(e.target.result);
                            break;
                    }
                } catch (error) {
                    alert('インポートに失敗しました: ' + error.message);
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else if (file.name.endsWith('.txt')) {
                reader.readAsText(file);
            } else if (file.name.endsWith('.xls')) {
                reader.readAsBinaryString(file);
            }
        });

        function importJSON(content) {
            const data = JSON.parse(content);
            // JSONデータを各フィールドに設定
            if (data["質問と回答"]) {
                const qa = data["質問と回答"];
                document.getElementById('q1').value = qa["Q1. 1日の検体数"] || '';
                document.getElementById('q2').value = qa["Q2. 1時間当たりの最大検体数"] || '';
                document.getElementById('q3').value = qa["Q3. 別号機再検の希望"] || '';
                document.getElementById('q4-1').checked = qa["Q4. セルパックの交換頻度を減らしたい"] === "はい";
                document.getElementById('q5-1').checked = qa["Q5. セルパックの在庫スペースを削減したい"] === "はい";
                document.getElementById('q6-1').checked = qa["Q6. 造血幹細胞移植をしている"] === "はい";
                document.getElementById('q7-1').checked = qa["Q7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい"] === "はい";
                document.getElementById('q8-1').checked = qa["Q8. IPFの臨床要望がある"] === "はい";
                document.getElementById('q9-1').checked = qa["Q9. PLT 5万以下の検体数が多い"] === "はい";
                document.getElementById('q10-1').checked = qa["Q10. 破砕赤血球の出現検体が時々ある"] === "はい";
                document.getElementById('q11-1').checked = qa["Q11. 体液の機械値報告をしたい"] === "はい";
                document.getElementById('q12-1').checked = qa["Q12. 当直帯に体液検体の報告が必要"] === "はい";
                document.getElementById('q13-1').checked = qa["Q13. 体液の鏡検者の不足またはスキル継続に課題がある"] === "はい";
                document.getElementById('q14').value = qa["Q14. 標本枚数/日"] || '';
                document.getElementById('q15').value = qa["Q15. 現在、血液像自動分析装置の有無"] || '';
                document.getElementById('q16-1').checked = qa["Q16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい"] === "はい";
                document.getElementById('q17-1').checked = qa["Q17. 検査室内での鏡検スキルの平準化を進めたい"] === "はい";
                document.getElementById('q18').value = qa["Q18. SPないしDIが複数台数あるか"] || '';
                document.getElementById('q19').value = qa["Q19. 設置面積をできる限り狭くしたいか"] || '';
                document.getElementById('q20').value = qa["Q20. TS-10の検体回収作業を端で行いたいか"] || '';
                document.getElementById('q21-1').checked = qa["Q21. 血液・凝固検査を含めた自動化を進めたい"] === "はい";
                document.getElementById('q22-1').checked = qa["Q22. 血液・凝固検査の担当人員を減らしたい"] === "はい";
                document.getElementById('q23-1').checked = qa["Q23. 夜間当直帯の装置オペレーションを少なくしたい"] === "はい";
            }
            calculateResult();
        }

        function importCSV(content) {
            const lines = content.split('\n');
            const data = {};
            lines.forEach(line => {
                const [section, key, value] = line.split(',').map(item => item.replace(/"/g, ''));
                if (key && value) {
                    data[key] = value;
                }
            });
            // CSVデータを各フィールドに設定
            document.getElementById('q1').value = data["Q1. 1日の検体数"] || '';
            document.getElementById('q2').value = data["Q2. 1時間当たりの最大検体数"] || '';
            document.getElementById('q3').value = data["Q3. 別号機再検の希望"] || '';
            document.getElementById('q4-1').checked = data["Q4. セルパックの交換頻度を減らしたい"] === "はい";
            document.getElementById('q5-1').checked = data["Q5. セルパックの在庫スペースを削減したい"] === "はい";
            document.getElementById('q6-1').checked = data["Q6. 造血幹細胞移植をしている"] === "はい";
            document.getElementById('q7-1').checked = data["Q7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい"] === "はい";
            document.getElementById('q8-1').checked = data["Q8. IPFの臨床要望がある"] === "はい";
            document.getElementById('q9-1').checked = data["Q9. PLT 5万以下の検体数が多い"] === "はい";
            document.getElementById('q10-1').checked = data["Q10. 破砕赤血球の出現検体が時々ある"] === "はい";
            document.getElementById('q11-1').checked = data["Q11. 体液の機械値報告をしたい"] === "はい";
            document.getElementById('q12-1').checked = data["Q12. 当直帯に体液検体の報告が必要"] === "はい";
            document.getElementById('q13-1').checked = data["Q13. 体液の鏡検者の不足またはスキル継続に課題がある"] === "はい";
            document.getElementById('q14').value = data["Q14. 標本枚数/日"] || '';
            document.getElementById('q15').value = data["Q15. 現在、血液像自動分析装置の有無"] || '';
            document.getElementById('q16-1').checked = data["Q16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい"] === "はい";
            document.getElementById('q17-1').checked = data["Q17. 検査室内での鏡検スキルの平準化を進めたい"] === "はい";
            document.getElementById('q18').value = data["Q18. SPないしDIが複数台数あるか"] || '';
            document.getElementById('q19').value = data["Q19. 設置面積をできる限り狭くしたいか"] || '';
            document.getElementById('q20').value = data["Q20. TS-10の検体回収作業を端で行いたいか"] || '';
            document.getElementById('q21-1').checked = data["Q21. 血液・凝固検査を含めた自動化を進めたい"] === "はい";
            document.getElementById('q22-1').checked = data["Q22. 血液・凝固検査の担当人員を減らしたい"] === "はい";
            document.getElementById('q23-1').checked = data["Q23. 夜間当直帯の装置オペレーションを少なくしたい"] === "はい";
            calculateResult();
        }

        function importTXT(content) {
            const lines = content.split('\n');
            const data = {};
            let isQA = false;
            lines.forEach(line => {
                if (line.includes('【質問と回答】')) {
                    isQA = true;
                } else if (line.includes('【分析結果】')) {
                    isQA = false;
                } else if (isQA) {
                    const [key, value] = line.split(':').map(item => item.trim());
                    if (key && value) {
                        data[key] = value;
                    }
                }
            });
            // テキストデータを各フィールドに設定
            document.getElementById('q1').value = data["Q1. 1日の検体数"] || '';
            document.getElementById('q2').value = data["Q2. 1時間当たりの最大検体数"] || '';
            document.getElementById('q3').value = data["Q3. 別号機再検の希望"] || '';
            document.getElementById('q4-1').checked = data["Q4. セルパックの交換頻度を減らしたい"] === "はい";
            document.getElementById('q5-1').checked = data["Q5. セルパックの在庫スペースを削減したい"] === "はい";
            document.getElementById('q6-1').checked = data["Q6. 造血幹細胞移植をしている"] === "はい";
            document.getElementById('q7-1').checked = data["Q7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい"] === "はい";
            document.getElementById('q8-1').checked = data["Q8. IPFの臨床要望がある"] === "はい";
            document.getElementById('q9-1').checked = data["Q9. PLT 5万以下の検体数が多い"] === "はい";
            document.getElementById('q10-1').checked = data["Q10. 破砕赤血球の出現検体が時々ある"] === "はい";
            document.getElementById('q11-1').checked = data["Q11. 体液の機械値報告をしたい"] === "はい";
            document.getElementById('q12-1').checked = data["Q12. 当直帯に体液検体の報告が必要"] === "はい";
            document.getElementById('q13-1').checked = data["Q13. 体液の鏡検者の不足またはスキル継続に課題がある"] === "はい";
            document.getElementById('q14').value = data["Q14. 標本枚数/日"] || '';
            document.getElementById('q15').value = data["Q15. 現在、血液像自動分析装置の有無"] || '';
            document.getElementById('q16-1').checked = data["Q16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい"] === "はい";
            document.getElementById('q17-1').checked = data["Q17. 検査室内での鏡検スキルの平準化を進めたい"] === "はい";
            document.getElementById('q18').value = data["Q18. SPないしDIが複数台数あるか"] || '';
            document.getElementById('q19').value = data["Q19. 設置面積をできる限り狭くしたいか"] || '';
            document.getElementById('q20').value = data["Q20. TS-10の検体回収作業を端で行いたいか"] || '';
            document.getElementById('q21-1').checked = data["Q21. 血液・凝固検査を含めた自動化を進めたい"] === "はい";
            document.getElementById('q22-1').checked = data["Q22. 血液・凝固検査の担当人員を減らしたい"] === "はい";
            document.getElementById('q23-1').checked = data["Q23. 夜間当直帯の装置オペレーションを少なくしたい"] === "はい";
            calculateResult(); // 結果を再計算
        }

        function importXLS(content) {
            // この関数はExcel形式のインポートを想定していますが、実装が必要です。
            alert('Excel形式のインポートは現在サポートされていません。');
        }

        // 音声認識の初期化
        let recognition;
        let isRecording = false;
        let transcriptBuffer = '';
        let fullTranscript = '';  // 全体の会話を保持
        let summaryHistory = [];  // 要約履歴を保持する配列
        let conversationHistory = [];  // 会話履歴を保持する配列
        let currentSummary = {};  // 現在の要約内容を保持
        
        // 音声認識のオプション
        const recognitionConfig = {
            continuous: true,
            interimResults: true,
            lang: 'ja-JP',
            maxAlternatives: 1
        };

        function initSpeechRecognition() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            Object.assign(recognition, recognitionConfig);

            // エラーハンドリング
            recognition.onerror = function(event) {
                console.error('音声認識エラー:', event.error);
                document.getElementById('recordingStatus').textContent = 
                    'エラーが発生しました: ' + event.error;
            };

            // 音声認識が終了した時の処理
            recognition.onend = function() {
                if (isRecording) {
                    recognition.start();  // 継続的な認識のために再開
                }
            };

            recognition.onresult = async function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + '\n';
                        // 会話履歴に追加
                        conversationHistory.push({
                            time: new Date().toLocaleTimeString(),
                            text: event.results[i][0].transcript
                        });
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                if (finalTranscript) {
                    fullTranscript += finalTranscript;
                    transcriptBuffer += finalTranscript;
                    
                    if (transcriptBuffer.split('。').length > 3) {
                        await summarizeConversation(transcriptBuffer);
                        transcriptBuffer = '';
                    }
                }

                document.getElementById('recordingStatus').textContent = 
                    '録音中: ' + (interimTranscript || finalTranscript || '音声を認識中...');
            };
        }

        async function summarizeConversation(text) {
            try {
                const previousSummary = currentSummary;
                
                const response = await fetch(config.API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + config.API_KEY
                    },
                    body: JSON.stringify({
                        model: "gpt-4-turbo",
                        messages: [{
                            role: "system",
                            content: `あなたは医療機器メーカーの営業担当者のアシスタントです。
                            顧客とのヒアリング内容から以下の点をまとめてください。要約結果は更新しても下記のQ1～の順番通り保持してください。：
                            Q1. 1日の検体数: 
                            Q2. 1時間当たりの最大検体数: 
                            Q3. 別号機再検の希望: 
                            Q4. セルパックの交換頻度を減らしたい: 
                            Q5. セルパックの在庫スペースを削減したい: 
                            Q6. 造血幹細胞移植をしている: 
                            Q7. IPメッセージ「Blasts/Abn Lympho?」の精査をしたい: 
                            Q8. IPFの臨床要望がある: 
                            Q9. PLT 5万以下の検体数が多い: 
                            Q10. 破砕赤血球の出現検体が時々ある: 
                            Q11. 体液の機械値報告をしたい: 
                            Q12. 当直帯に体液検体の報告が必要: 
                            Q13. 体液の鏡検者の不足またはスキル継続に課題がある: 
                            Q14. 標本枚数/日: 
                            Q15. 現在、血液像自動分析装置の有無: 
                            Q16. 鏡検枚数が200枚以上/日であり、鏡検数の低減をしたい: 
                            Q17. 検査室内での鏡検スキルの平準化を進めたい: 
                            Q18. SPないしDIが複数台数あるか: 
                            Q19. 設置面積をできる限り狭くしたいか: 
                            Q20. TS-10の検体回収作業を端で行いたいか: 
                            Q21. 血液・凝固検査を含めた自動化を進めたい: 
                            Q22. 血液・凝固検査の担当人員を減らしたい: 
                            Q23. 夜間当直帯の装置オペレーションを少なくしたい: 
                            Q24. 日々の困りごとなど: 
                            また、前回の要約内容がある場合は、その情報を保持したまま更新してください。`
                        }, {
                            role: "assistant",
                            content: (previousSummary.text || "").trim()
                        }, {
                            role: "user",
                            content: text
                        }],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                const summary = data.choices[0].message.content.trim();
                
                // 現在の要約を更新
                currentSummary = {
                    time: new Date().toLocaleTimeString(),
                    text: summary,
                    conversation: [...conversationHistory]
                };
                
                // 要約を履歴に追加
                summaryHistory.push({
                    time: new Date().toLocaleTimeString(),
                    text: summary,
                    originalText: text,
                    conversation: [...conversationHistory]
                });
                
                const summaryElement = document.getElementById('conversationSummary');
                // 全ての要約履歴を表示（最新の要約を上に表示）
                summaryElement.innerHTML = summaryHistory.map((item, index) => `<div class="summary-item ${index === summaryHistory.length - 1 ? 'latest' : ''}" id="${index === summaryHistory.length - 1 ? 'latestSummary' : ''}"><div class="summary-time">${item.time}</div><div class="conversation-text"><strong>会話内容:</strong><pre>${item.conversation.map(conv => `[${conv.time}] ${conv.text.trim()}`).join('\n')}</pre></div><div class="summary-text"><strong>AIメモ:</strong><br>${item.text.trim()}</div></div>`).join('');

                // 最新の要約にスクロール
                const latestSummary = document.getElementById('latestSummary');
                if (latestSummary) {
                    latestSummary.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start'
                    });
                }

                // 会話内容の自動スクロール
                const conversationElements = document.querySelectorAll('.conversation-text');
                if (conversationElements.length > 0) {
                    const latestConversation = conversationElements[conversationElements.length - 1];
                    scrollToLatestConversation(latestConversation);
                }

            } catch (error) {
                console.error('要約エラー:', error);
                document.getElementById('recordingStatus').textContent = 
                    '要約処理でエラーが発生しました';
            }
        }

        // 録音開始時に履歴をクリアするかどうかを確認
        function startVoiceRecording() {
            if (!isRecording) {
                if (summaryHistory.length > 0) {
                    if (confirm('新しい会話を開始しますか？以前の要約は消去されます。')) {
                        summaryHistory = [];
                        conversationHistory = [];
                        currentSummary = {};
                        document.getElementById('conversationSummary').innerHTML = '';
                    }
                }
                if (!recognition) {
                    initSpeechRecognition();
                }
                recognition.start();
                isRecording = true;
                document.getElementById('recordButton').classList.add('recording');
                document.getElementById('recordingStatus').textContent = '録音中...';
            } else {
                recognition.stop();
                isRecording = false;
                document.getElementById('recordButton').classList.remove('recording');
                document.getElementById('recordingStatus').textContent = '録音停止';
                if (transcriptBuffer.length > 0) {
                    summarizeConversation(transcriptBuffer);
                    transcriptBuffer = '';
                }
            }
        }

        function toggleVoiceSection() {
            const section = document.getElementById('voiceSection');
            if (section.classList.contains('visible')) {
                section.classList.remove('visible');
            } else {
                section.classList.add('visible');
            }
        }

        // 会話内容の自動スクロール
        function scrollToLatestConversation(conversationElement) {
            if (conversationElement) {
                conversationElement.scrollTop = conversationElement.scrollHeight;
            }
        }

        // 会話内容のエクスポート
        function exportConversation() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `conversation_${timestamp}`;
            
            // エクスポートするデータの準備
            const exportData = summaryHistory.map(item => ({
                time: item.time,
                conversation: item.conversation.map(conv => `[${conv.time}] ${conv.text}`).join('\n'),
                summary: item.text
            }));
            
            // エクスポートメニューの表示
            const menu = document.createElement('div');
            menu.className = 'export-menu';
            menu.innerHTML = `
                <div class="export-menu-content">
                    <button onclick="exportAs('txt', '${filename}')">テキストファイル (.txt)</button>
                    <button onclick="exportAs('json', '${filename}')">JSON形式 (.json)</button>
                    <button onclick="exportAs('csv', '${filename}')">CSV形式 (.csv)</button>
                </div>
            `;
            document.body.appendChild(menu);
            
            // メニューを一定時間後に自動的に閉じる
            setTimeout(() => {
                document.body.removeChild(menu);
            }, 5000);
        }

        // 各形式でのエクスポート
        function exportAs(format, filename) {
            const data = summaryHistory.map(item => ({
                time: item.time,
                conversation: item.conversation.map(conv => `[${conv.time}] ${conv.text}`).join('\n'),
                summary: item.text
            }));

            let content = '';
            let type = '';
            
            switch(format) {
                case 'txt':
                    content = data.map(item => 
                        `時刻: ${item.time}\n\n会話内容:\n${item.conversation}\n\nAIメモ:\n${item.summary}\n\n${'-'.repeat(50)}\n`
                    ).join('\n');
                    type = 'text/plain';
                    break;
                case 'json':
                    content = JSON.stringify(data, null, 2);
                    type = 'application/json';
                    break;
                case 'csv':
                    content = 'Time,Conversation,Summary\n' + 
                        data.map(item => 
                            `"${item.time}","${item.conversation.replace(/"/g, '""')}","${item.summary.replace(/"/g, '""')}"`
                        ).join('\n');
                    type = 'text/csv';
                    break;
            }

            const blob = new Blob([content], { type: `${type};charset=utf-8` });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Mermaid の初期化
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        function displayLogicChart() {
            const content = document.getElementById('logicChartContent');
            content.innerHTML = `
                <div class="mermaid">
                    graph TB
                    %% XRモジュール台数判定
                    subgraph XR台数判定1
                    A[1日の検体数] --> A1{判定1}
                    A1 -->|≧1200| X1[6台]
                    A1 -->|≧1000| X2[5台]
                    A1 -->|≧800| X3[4台]
                    A1 -->|≧600| X4[3台]
                    A1 -->|≦599| X5[2台]
                    end

                    subgraph XR台数判定2
                    B[1時間当たりの最大検体数] --> B1{判定2}
                    B1 -->|≧400| Y1[5台]
                    B1 -->|≧300| Y2[4台]
                    B1 -->|≧200| Y3[3台]
                    B1 -->|≧100| Y4[2台]
                    B1 -->|その他| Y5[1台]
                    end

                    X1 & X2 & X3 & X4 & X5 --> XR{最大値選択}
                    Y1 & Y2 & Y3 & Y4 & Y5 --> XR

                    %% モジュール構成判定
                    XR --> MT{モジュール判定}
                    C[別号機再検] --> MT
                    MT -->|偶数台数かつ再検あり| TW[ツインモジュール]
                    MT -->|その他| SG[シングルモジュール]
                      
                    %% オプション判定（直列処理）
                    TW & SG --> RU{RU判定}
                    Q4[セルパックの交換頻度を減らしたい] --> RU
                    Q5[セルパックの在庫スペースを削減したい] --> RU
                    RU -->|いずれかYes| RU1[RUあり]
                    RU -->|両方No| RU2[RUなし]
                      
                    RU1 --> WPC{WPC判定}
                    RU2 --> WPC
                    Q6[造血幹細胞移植] --> WPC
                    Q7[IPメッセージ「Blasts/Abn Lympho?」の精査] --> WPC
                    WPC -->|いずれかYes| WPC1[WPCあり]
                    WPC -->|両方No| WPC2[WPCなし]

                    WPC1 --> PLT{PLT-F判定}
                    WPC2 --> PLT
                    Q8[IPF測定] --> PLT
                    Q9[PLT5万以下] --> PLT
                    Q10[破砕赤血球] --> PLT
                    PLT -->|いずれかYes| PLT1[PLT-Fあり]
                    PLT -->|全てNo| PLT2[PLT-Fなし]

                    PLT1 --> BF{BF判定}
                    PLT2 --> BF
                    Q11[体液機械値報告] --> BF
                    Q12[当直帯の体液測定] --> BF
                    Q13[体液鏡検者不足] --> BF
                    BF -->|いずれかYes| BF1[BFあり]
                    BF -->|全てNo| BF2[BFなし]

                    BF1 --> SP{SP-50判定}
                    BF2 --> SP
                    Q14[1日塗抹枚数] --> SP
                    SP -->|<150枚| SP1[SP-50 1台]
                    SP -->|≧150枚| SP2[SP-50 2台]

                    SP1 --> DI{DI-60判定}
                    SP2 --> DI
                    Q15[DI-60の有無] --> DI
                    Q16[鏡検数が200枚以上/日] --> DI
                    Q17[鏡検スキルの平準化] --> DI
                    DI -->|いずれかYes| DI1[DI-60あり]
                    DI -->|全てNo| DI2[DI-60なし]

                    DI1 --> TS{TS-10判定}
                    DI2 --> TS
                    Q20[回収を端で行いたいか] --> TS
                    TS -->|あり| TS1[TS-10最後尾]
                    TS -->|なし| TS2[TS-10中央]
                </div>
            `;
            
            // Mermaidの再描画
            mermaid.init(undefined, document.querySelector(".mermaid"));
        }

        // モーダルを開いた時にチャートを再描画
        function toggleLogicChart() {
            const modal = document.getElementById('logicChartModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
                displayLogicChart();
                // ウィンドサイズに合わせて再描画
                window.dispatchEvent(new Event('resize'));
            }
        }
    </script>
</body>
</html>
